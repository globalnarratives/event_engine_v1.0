{% extends "base.html" %}

{% block title %}Link Event - {{ marked.display_name }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <h1>Link Event to Assessment</h1>
    <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
        Assessment: <span style="color: var(--color-accent-primary); font-family: var(--font-body);">{{ marked.display_name }}</span>
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="card mb-md flash-{{ category }}">
                    <div class="card-body">
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Current Probability Display -->
    <div class="card mb-lg" style="background-color: var(--color-bg-elevated);">
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: var(--color-text-tertiary); font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.25rem;">
                        Current Probability
                    </div>
                    <div style="color: var(--color-accent-primary); font-size: 2rem; font-weight: 700; font-family: var(--font-body);">
                        {{ (marked.current_probability * 100)|round(1) }}%
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--color-text-tertiary); font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.25rem;">
                        Linked Events
                    </div>
                    <div style="color: var(--color-text-primary); font-size: 1.5rem; font-weight: 600;">
                        {{ marked.event_links|length }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Event Form -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Link New Event</h2>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="form-group">
                    <label class="form-label" for="event_code">Event Code</label>
                    <input type="text" id="event_code" name="event_code" 
                           class="form-input" placeholder="e.17012026.nam.001" 
                           required autofocus list="available-events">
                    <datalist id="available-events">
                        {% for event in available_events %}
                        <option value="{{ event.event_code }}">
                            {{ event.event_code }} - {{ event.rec_timestamp.strftime('%Y-%m-%d') if event.rec_timestamp else '' }}
                        </option>
                        {% endfor %}
                    </datalist>
                    <p style="font-size: 0.75rem; color: var(--color-text-dim); margin-top: 0.25rem;">
                        Start typing to see recent events
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="weight">Event Weight</label>
                    <input type="number" id="weight" name="weight" 
                           class="form-input" step="0.1" min="-12" max="12"
                           placeholder="3.5" required>
                    <p style="font-size: 0.75rem; color: var(--color-text-dim); margin-top: 0.25rem;">
                        <strong>Weight scale:</strong> -12.0 to +12.0 (0.1 increments, excluding 0)<br>
                        <strong>Categories:</strong> Minor (0.1-4.0), Moderate (5.0-7.0), Major (8.0-10.0), Critical (11.0-12.0)<br>
                        Positive weights increase probability, negative weights decrease it.
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes">Notes (Optional)</label>
                    <textarea id="notes" name="notes" class="form-textarea" rows="3"
                              placeholder="Explain why this event affects the scenario..."></textarea>
                </div>

                <div class="card bg-elevated" style="padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid var(--color-accent-primary);">
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        <strong>Note:</strong> The probability will be automatically recalculated when you link this event.
                    </p>
                </div>

                <div class="flex gap-md">
                    <button type="submit" class="btn btn-primary">Link Event</button>
                    <a href="{{ url_for('scenarios.marked_detail', marked_id=marked.id) }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Recently Available Events -->
    {% if available_events %}
    <div class="card mt-lg">
        <div class="card-header">
            <h2 class="card-title">Recent Events (Not Yet Linked)</h2>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Event Code</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in available_events[:10] %}
                    <tr>
                        <td>
                            <a href="{{ url_for('events.detail_cf_route', event_code=event.event_code) }}" 
                               style="color: var(--color-accent-primary); font-family: var(--font-body);" 
                               target="_blank">
                                {{ event.event_code }}
                            </a>
                        </td>
                        <td style="color: var(--color-text-secondary);">
                            {{ event.rec_timestamp.strftime('%Y-%m-%d') if event.rec_timestamp else 'N/A' }}
                        </td>
                        <td>
                            <button type="button" class="btn btn-secondary" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                    onclick="document.getElementById('event_code').value='{{ event.event_code }}'; window.scrollTo(0,0);">
                                Select
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}