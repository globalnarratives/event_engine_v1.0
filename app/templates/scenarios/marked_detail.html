{% extends "base.html" %}

{% block title %}{{ marked.display_name }}{% endblock %}

{% block content %}
<div class="marked-detail-container">
    <!-- Header Section - Spans all columns -->
    <div class="marked-header">
        <h1>{{ marked.display_name }}</h1>
        <p class="text-secondary mb-lg">
            Assessment by {{ marked.analyst.username }}
        </p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="card mb-md flash-{{ category }}">
                        <div class="card-body">
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Left Column -->
    <div class="marked-left-column">
        <!-- Assessment Info -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Assessment Details</h2>
            </div>
            <div class="card-body">
                <table class="detail-table">
                    <tr>
                        <td class="detail-label">Scenario</td>
                        <td class="detail-value">
                            <a href="{{ url_for('scenarios.detail', scenario_id=marked.scenario.id) }}" class="code-link">
                                {{ marked.scenario.scenario_code }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Proposition</td>
                        <td class="detail-value text-primary">
                            {{ marked.scenario.title }}
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Start Date</td>
                        <td class="detail-value">
                            {{ marked.scenario.start_date.strftime('%Y-%m-%d') if marked.scenario.start_date else 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Resolution Date</td>
                        <td class="detail-value">
                            {{ marked.scenario.close_date.strftime('%Y-%m-%d') if marked.scenario.close_date else 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Analyst</td>
                        <td class="detail-value text-primary">
                            {{ marked.analyst.username }}
                        </td>
                    </tr>
                    {% if marked.title %}
                    <tr>
                        <td class="detail-label">Label</td>
                        <td class="detail-value text-primary">
                            {{ marked.title }}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="detail-label">Status</td>
                        <td class="detail-value">
                            {% if marked.status == 'active' %}
                                <span class="badge badge-active">ACTIVE</span>
                            {% elif marked.status == 'resolved_true' %}
                                <span class="badge badge-active">RESOLVED TRUE</span>
                            {% elif marked.status == 'resolved_false' %}
                                <span class="badge badge-resolved">RESOLVED FALSE</span>
                            {% else %}
                                <span class="badge badge-resolved">{{ marked.status|upper }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="detail-label">Created</td>
                        <td class="detail-value">
                            {{ marked.created_at.strftime('%Y-%m-%d %H:%M') if marked.created_at else 'N/A' }}
                        </td>
                    </tr>
                </table>

                {% if marked.description %}
                <div class="detail-notes">
                    <div class="detail-notes-label">Notes</div>
                    <div class="detail-notes-content">
                        {{ marked.description }}
                    </div>
                </div>
                {% endif %}

                <div class="detail-actions">
                    <a href="{{ url_for('scenarios.detail', scenario_id=marked.scenario.id) }}" class="btn btn-secondary">
                        Back to Scenario
                    </a>
                </div>
            </div>
        </div>

        <!-- Probability History Text List -->
        {% if marked.probability_history and marked.probability_history|length > 1 %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Probability History</h2>
            </div>
            <div class="card-body">
                <div class="history-list">
                    {% for entry in marked.probability_history|reverse %}
                    <div class="history-entry">
                        <div class="history-entry-header">
                            <span class="history-probability">
                                {{ (entry.probability * 100)|round(1) }}%
                            </span>
                            <span class="history-date">
                                {{ entry.timestamp[:10] if entry.timestamp else 'N/A' }}
                            </span>
                        </div>
                        <div class="history-reason">
                            {{ entry.reason }}
                        </div>
                        {% if entry.event_code %}
                        <div class="history-event">
                            <a href="{{ url_for('events.detail_cf_route', event_code=entry.event_code) }}" class="event-link">
                                → {{ entry.event_code }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Middle Column -->
    <div class="marked-middle-column">
        <!-- Probability Chart -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Probability Over Time</h2>
            </div>
            <div class="card-body">
                <!-- Current Stats Display -->
                <div class="prob-stats">
                    <div class="prob-stat">
                        <div class="prob-stat-label">Initial</div>
                        <div class="prob-stat-value">
                            {{ (marked.initial_probability * 100)|round(1) }}%
                        </div>
                    </div>
                    <div class="prob-stat">
                        <div class="prob-stat-label">Current</div>
                        <div class="prob-stat-value prob-stat-current">
                            {{ (marked.current_probability * 100)|round(1) }}%
                        </div>
                    </div>
                </div>

                <!-- Chart Canvas -->
                <canvas id="probabilityChart" 
                    data-history='{{ marked.probability_history|tojson|safe }}'
                    class="prob-chart"></canvas>
            </div>
        </div>

        <!-- Linked Events -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Linked Events ({{ event_links|length }})</h2>
                {% if current_user.id == marked.analyst_id %}
                <button class="btn btn-primary link-event-btn">Link Event</button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if event_links %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Event Code</th>
                                <th>Weight</th>
                                <th>Linked</th>
                                {% if current_user.id == marked.analyst_id %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for link in event_links %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('events.detail_cf_route', event_code=link.event_code) }}" class="code-link">
                                        {{ link.event_code }}
                                    </a>
                                    {% if link.notes %}
                                    <div class="link-notes">
                                        {{ link.notes }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="{% if link.weight > 0 %}weight-positive{% elif link.weight < 0 %}weight-negative{% else %}weight-neutral{% endif %}">
                                        {% if link.weight > 0 %}+{% endif %}{{ link.weight }}
                                    </span>
                                </td>
                                <td class="text-dim small-text">
                                    {{ link.linked_at.strftime('%Y-%m-%d') if link.linked_at else 'N/A' }}
                                </td>
                                {% if current_user.id == marked.analyst_id %}
                                <td>
                                    <form method="POST" action="{{ url_for('scenarios.unlink_event', marked_id=marked.id, event_code=link.event_code) }}" class="inline-form">
                                        <button type="submit" class="btn btn-warning btn-small"
                                                onclick="return confirm('Remove this event link? Probability will be adjusted.');">
                                            Unlink
                                        </button>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty-state">
                        No events linked yet.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Link Event Sidebar (hidden by default) -->
    <div class="link-event-sidebar">
        <!-- Header with close button -->
        <div class="sidebar-header">
            <h2 class="sidebar-title">LINK EVENT</h2>
            <button class="close-sidebar sidebar-close-btn">&times;</button>
        </div>
        
        <form method="POST" action="{{ url_for('scenarios.link_event', marked_id=marked.id) }}">
            <!-- Section 1: Events Listing -->
            <div class="mb-lg">
                <label class="form-label">AVAILABLE EVENTS</label>
                <div class="event-list-container">
                    
                    {% set available_events = [] %}
                    {% for event in all_events %}
                        {% if event.event_code not in linked_event_codes %}
                            {% set _ = available_events.append(event) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if available_events %}
                        {% set events_by_region = {} %}
                        {% for event in available_events %}
                            {% set region = event.event_code.split('.')[2] if event.event_code else 'unknown' %}
                            {% if region not in events_by_region %}
                                {% set _ = events_by_region.update({region: []}) %}
                            {% endif %}
                            {% set _ = events_by_region[region].append(event) %}
                        {% endfor %}
                        
                        {% for region, events in events_by_region.items()|sort %}
                            <!-- Region Header -->
                            <div class="event-region-header">
                                {{ region.upper() }}
                            </div>
                            
                            <!-- Events in Region (sorted by date, most recent first) -->
                            {% for event in events|sort(attribute='rec_timestamp', reverse=True) %}
                            <div class="event-list-item" 
                                onclick="selectEvent(this, '{{ event.event_code }}', '{{ event.event_actor }}', '{{ event.action_code }}')">
                                <div class="event-list-item-content">
                                    <!-- Checkbox -->
                                    <input type="radio" name="event_radio" value="{{ event.event_code }}" 
                                        class="event-radio"
                                        onclick="event.stopPropagation();">
                                    
                                    <!-- Event Details -->
                                    <div class="event-list-details">
                                        <!-- Event Code -->
                                        <div class="event-code">
                                            {{ event.event_code }}
                                        </div>
                                        
                                        <!-- Actor and Action -->
                                        <div class="event-meta">
                                            <span class="text-primary">{{ event.event_actor or 'N/A' }}</span>
                                            <span class="event-separator">•</span>
                                            <span class="text-accent">{{ event.action_code or 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            No available events to link
                        </div>
                    {% endif %}
                    
                </div>
            </div>
            
            <!-- Section 2: Selected Event Display -->
            <div class="mb-lg">
                <label class="form-label">SELECTED EVENT</label>
                <div id="selected-event-display" class="selected-event-display">
                    No event selected
                </div>
                <input type="hidden" name="event_code" id="selected-event-code" required>
            </div>
            
            <!-- Section 3: Weight Input -->
            <div class="mb-lg">
                <label class="form-label" for="weight">WEIGHT</label>
                <input type="number" id="weight" name="weight" 
                    class="form-input" step="0.1" min="-12" max="12"
                    placeholder="3.5" required>
                <p class="form-helper">
                    Minor (0.1-4.9), Moderate (5.0-7.9), Major (8.0-10.9), Critical (11.0-12.0)
                </p>
            </div>
            
            <!-- Section 4: Notes (Optional) -->
            <div class="mb-xl">
                <label class="form-label" for="notes">NOTES (OPTIONAL)</label>
                <textarea id="notes" name="notes" 
                        class="form-textarea" rows="3"
                        placeholder="Explain why this event affects the scenario..."></textarea>
            </div>
            
            <!-- Action Buttons -->
            <div class="sidebar-actions">
                <button type="submit" class="btn btn-primary btn-block">LINK EVENT</button>
                <button type="button" class="close-sidebar btn btn-secondary btn-block">CANCEL</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
(function() {
    const canvas = document.getElementById('probabilityChart');
    if (!canvas) return;

    // 1. Pull data from the HTML attributes we set above
    const rawHistory = JSON.parse(canvas.dataset.history || '[]');

    // 2. Map the data into the format Chart.js expects
   const dataPoints = rawHistory.map(entry => {
        let eventDate;
        
        // Initial assessment: use scenario start_date
        if (!entry.event_code) {
            eventDate = new Date('{{ marked.scenario.start_date.isoformat() }}');
        } else if (entry.event_code.startsWith('e.')) {
            // Parse event date from event_code (format: e.DDMMYYYY.region.ordinal)
            const datePart = entry.event_code.split('.')[1]; // e.g., "17012026"
            if (datePart && datePart.length === 8) {
                const day = datePart.substring(0, 2);
                const month = datePart.substring(2, 4);
                const year = datePart.substring(4, 8);
                eventDate = new Date(`${year}-${month}-${day}`);
            }
        }
        
        // If parse failed, eventDate will be undefined and this entry will cause issues
        // This is intentional - we want to know if data is malformed
        
        return {
            x: eventDate,
            y: entry.probability
        };
   }).sort((a, b) => a.x - b.x);

    // Calculate min and max probability from data for Y-axis scaling
    const probabilities = dataPoints.map(p => p.y);
    const minProb = Math.min(...probabilities);
    const maxProb = Math.max(...probabilities);

    

    // 3. Initialize Chart
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Probability',
                data: dataPoints,
                borderColor: '#33f5ff',
                backgroundColor: 'rgba(51, 245, 255, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => (context.parsed.y * 100).toFixed(1) + '%'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, minProb - 0.05),    // Add 5% buffer below
                    max: Math.min(1, maxProb + 0.05),    // Add 5% buffer above
                    ticks: {
                        callback: function(value) {
                            return (value * 100).toFixed(1) + '%';
                        }
                    }
                },
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }
            }
        }
    });
})();
</script>

<script>
// Toggle link event sidebar
document.addEventListener('DOMContentLoaded', function() {
    const linkBtn = document.querySelector('.link-event-btn');
    const container = document.querySelector('.marked-detail-container');
    const closeBtn = document.querySelector('.close-sidebar');
    
    if (linkBtn) {
        linkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            container.classList.add('link-mode');
        });
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            container.classList.remove('link-mode');
        });
    }
});
</script>

<script>
// Event selection handler
function selectEvent(element, eventCode, eventActor, actionCode) {
    // Update radio button
    const radio = element.querySelector('input[type="radio"]');
    radio.checked = true;
    
    // Update hidden input
    document.getElementById('selected-event-code').value = eventCode;
    
    // Update selected event display
    const display = document.getElementById('selected-event-display');
    display.innerHTML = `
        <div class="selected-event-content">
            <div class="selected-event-code">
                ${eventCode}
            </div>
            <div class="selected-event-meta">
                ${eventActor || 'N/A'} • ${actionCode || 'N/A'}
            </div>
        </div>
    `;
    
    // Highlight selected item
    document.querySelectorAll('.event-list-item').forEach(item => {
        item.classList.remove('selected');
    });
    element.classList.add('selected');
}
</script>

{% endblock %}