{% extends "base.html" %}

{% block title %}{{ marked.display_name }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ marked.display_name }}</h1>
    <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
        Assessment by {{ marked.analyst.username }}
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="card mb-md flash-{{ category }}">
                    <div class="card-body">
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="grid" style="grid-template-columns: 500px 800px; gap: 1.5rem;">
        <!-- Left Column -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Assessment Info -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assessment Details</h2>
                </div>
                <div class="card-body">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; width: 180px;">
                                Scenario
                            </td>
                            <td style="padding: 0.75rem;">
                                <a href="{{ url_for('scenarios.detail', scenario_id=marked.scenario.id) }}" 
                                   style="color: var(--color-accent-primary); font-family: var(--font-body);">
                                    {{ marked.scenario.scenario_code }}
                                </a>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Proposition
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-primary);">
                                {{ marked.scenario.title }}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Start Date
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-secondary);">
                                {{ marked.scenario.start_date.strftime('%Y-%m-%d') if marked.scenario.start_date else 'N/A' }}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Resolution Date
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-secondary);">
                                {{ marked.scenario.close_date.strftime('%Y-%m-%d') if marked.scenario.close_date else 'N/A' }}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Analyst
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-primary);">
                                {{ marked.analyst.username }}
                            </td>
                        </tr>
                        {% if marked.title %}
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Label
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-primary);">
                                {{ marked.title }}
                            </td>
                        </tr>
                        {% endif %}
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Status
                            </td>
                            <td style="padding: 0.75rem;">
                                {% if marked.status == 'active' %}
                                    <span class="badge badge-active">ACTIVE</span>
                                {% elif marked.status == 'resolved_true' %}
                                    <span class="badge badge-active">RESOLVED TRUE</span>
                                {% elif marked.status == 'resolved_false' %}
                                    <span class="badge badge-resolved">RESOLVED FALSE</span>
                                {% else %}
                                    <span class="badge badge-resolved">{{ marked.status|upper }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 0.75rem; color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">
                                Created
                            </td>
                            <td style="padding: 0.75rem; color: var(--color-text-secondary);">
                                {{ marked.created_at.strftime('%Y-%m-%d %H:%M') if marked.created_at else 'N/A' }}
                            </td>
                        </tr>
                    </table>

                    {% if marked.description %}
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border);">
                        <div style="color: var(--color-text-tertiary); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; margin-bottom: 0.75rem;">
                            Notes
                        </div>
                        <div style="color: var(--color-text-secondary); line-height: 1.6;">
                            {{ marked.description }}
                        </div>
                    </div>
                    {% endif %}

                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border);">
                        <a href="{{ url_for('scenarios.detail', scenario_id=marked.scenario.id) }}" class="btn btn-secondary">
                            Back to Scenario
                        </a>
                    </div>
                </div>
            </div>

            <!-- Probability History Text List -->
            {% if marked.probability_history and marked.probability_history|length > 1 %}
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Probability History</h2>
                </div>
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for entry in marked.probability_history|reverse %}
                        <div style="padding: 0.75rem; margin-bottom: 0.75rem; background: var(--color-bg-elevated); border-radius: var(--radius-sm); border-left: 3px solid var(--color-accent-primary);">
                            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.25rem;">
                                <span style="color: var(--color-accent-primary); font-weight: 600; font-size: 1.1rem; font-family: var(--font-body);">
                                    {{ (entry.probability * 100)|round(1) }}%
                                </span>
                                <span style="color: var(--color-text-dim); font-size: 0.85rem;">
                                    {{ entry.timestamp[:10] if entry.timestamp else 'N/A' }}
                                </span>
                            </div>
                            <div style="color: var(--color-text-secondary); font-size: 0.875rem;">
                                {{ entry.reason }}
                            </div>
                            {% if entry.event_code %}
                            <div style="margin-top: 0.25rem;">
                                <a href="{{ url_for('events.detail_cf_route', event_code=entry.event_code) }}" 
                                   style="color: var(--color-accent-secondary); font-size: 0.85rem; font-family: var(--font-body);">
                                    â†’ {{ entry.event_code }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Probability Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Probability Over Time</h2>
                </div>
                <div class="card-body">
                    <!-- Current Stats Display -->
                    <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border);">
                        <div style="text-align: center;">
                            <div style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">
                                Initial
                            </div>
                            <div style="color: var(--color-text-secondary); font-size: 1.5rem; font-weight: 600; font-family: var(--font-body);">
                                {{ (marked.initial_probability * 100)|round(1) }}%
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">
                                Current
                            </div>
                            <div style="color: var(--color-accent-primary); font-size: 2rem; font-weight: 700; font-family: var(--font-body);">
                                {{ (marked.current_probability * 100)|round(1) }}%
                            </div>
                        </div>
                    </div>

                    <!-- Chart Canvas -->
                    <canvas id="probabilityChart" 
                        data-history='{{ marked.probability_history|tojson|safe }}'
                        style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Linked Events -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title">Linked Events ({{ event_links|length }})</h2>
                    {% if current_user.id == marked.analyst_id %}
                    <a href="{{ url_for('scenarios.link_event', marked_id=marked.id) }}" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        Link Event
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if event_links %}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Event Code</th>
                                    <th>Weight</th>
                                    <th>Linked</th>
                                    {% if current_user.id == marked.analyst_id %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for link in event_links %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('events.detail_cf_route', event_code=link.event_code) }}" 
                                           style="color: var(--color-accent-primary); font-family: var(--font-body);">
                                            {{ link.event_code }}
                                        </a>
                                        {% if link.notes %}
                                        <div style="color: var(--color-text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                                            {{ link.notes }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="{% if link.weight > 0 %}weight-positive{% elif link.weight < 0 %}weight-negative{% else %}weight-neutral{% endif %}">
                                            {% if link.weight > 0 %}+{% endif %}{{ link.weight }}
                                        </span>
                                    </td>
                                    <td style="color: var(--color-text-dim); font-size: 0.85rem;">
                                        {{ link.linked_at.strftime('%Y-%m-%d') if link.linked_at else 'N/A' }}
                                    </td>
                                    {% if current_user.id == marked.analyst_id %}
                                    <td>
                                        <form method="POST" action="{{ url_for('scenarios.unlink_event', marked_id=marked.id, event_code=link.event_code) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-warning" 
                                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                                    onclick="return confirm('Remove this event link? Probability will be adjusted.');">
                                                Unlink
                                            </button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="color: var(--color-text-dim); text-align: center; padding: 2rem 0;">
                            No events linked yet.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
(function() {
    const canvas = document.getElementById('probabilityChart');
    if (!canvas) return;

    // 1. Pull data from the HTML attributes we set above
    const rawHistory = JSON.parse(canvas.dataset.history || '[]');

    // 2. Map the data into the format Chart.js expects
   const dataPoints = rawHistory.map(entry => {
        let eventDate;
        
        // Initial assessment: use scenario start_date
        if (!entry.event_code) {
            eventDate = new Date('{{ marked.scenario.start_date.isoformat() }}');
        } else if (entry.event_code.startsWith('e.')) {
            // Parse event date from event_code (format: e.DDMMYYYY.region.ordinal)
            const datePart = entry.event_code.split('.')[1]; // e.g., "17012026"
            if (datePart && datePart.length === 8) {
                const day = datePart.substring(0, 2);
                const month = datePart.substring(2, 4);
                const year = datePart.substring(4, 8);
                eventDate = new Date(`${year}-${month}-${day}`);
            }
        }
        
        // If parse failed, eventDate will be undefined and this entry will cause issues
        // This is intentional - we want to know if data is malformed
        
        return {
            x: eventDate,
            y: entry.probability
        };
    }).sort((a, b) => a.x - b.x);

    // 3. Initialize Chart
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Probability',
                data: dataPoints,
                borderColor: '#33f5ff',
                backgroundColor: 'rgba(51, 245, 255, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => (context.parsed.y * 100).toFixed(1) + '%'
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: { day: 'MMM d' }
                    },
                    title: { display: true, text: 'Date', color: '#b2b3b6' },
                    grid: { color: '#2a3441' },
                    ticks: { color: '#b2b3b6' }
                },
                y: {
                    grace: '10%',
                    title: { 
                        display: true, 
                        text: 'Probability', 
                        color: '#b2b3b6' 
                    },
                    grid: { 
                        color: '#2a3441' 
                    },
                    ticks: {
                        color: '#b2b3b6',
                        callback: (value) => (value * 100).toFixed(0) + '%'
                    }
                    
                }
            }
        }
    });
})();
</script>
{% endblock %}