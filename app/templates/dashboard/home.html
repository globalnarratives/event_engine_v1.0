{% extends 'base.html' %}
{% from 'components/event_card.html' import event_card %}

{% block title %}Dashboard - Global Narratives{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-title">
    <h1>MY DASHBOARD</h1>
</div>
<div class="dashboard-container">

    <!-- LEFT COLUMN -->
    <div class="dashboard-left-column">

        <!-- Build & Create Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Build & Create</h2>
            </div>
            <div class="card-body">
                <div class="dashboard-action-list">
                    <span class="dashboard-action-link disabled">
                        Create Narrative
                    </span>
                    <a href="{{ url_for('scenarios.create') }}" class="dashboard-action-link">
                        Create Scenario
                    </a>
                    <a href="{{ url_for('events.create_cf_route') }}" class="dashboard-action-link">
                        Create Event
                    </a>
                    <a href="{{ url_for('articles.dashboard') }}" class="dashboard-action-link">
                        Input Feed
                        {% if unprocessed_articles > 0 %}
                        <span class="dashboard-badge">{{ unprocessed_articles }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Foundations Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Tracked Elements</h2>
                <a href="{{ url_for('foundations.index') }}" class="btn btn-small btn-secondary">View All</a>
            </div>
            <div class="card-body">
                <!-- Cycling category selector -->
                <div class="foundations-cycle-header">
                    <span class="foundations-cycle-label" id="foundations-cycle-label">Actors</span>
                    <button class="foundations-cycle-btn" id="foundations-cycle-btn" type="button" title="Next category">&#9654;</button>
                </div>

                <!-- Actors tab -->
                <div class="foundations-tab-content active" id="tab-actors">
                    {% if tracked_actors %}
                        {% for actor in tracked_actors %}
                        <div class="tracked-entity-compact">
                            <a href="{{ url_for('foundations.actor_detail', actor_id=actor.code) }}" class="code-link">{{ actor.code }}</a>
                            <span class="entity-name-compact">{{ actor.display_name }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="dashboard-empty-state">No tracked actors. <a href="{{ url_for('foundations.index', tab='actors') }}">Browse actors</a></p>
                    {% endif %}
                </div>

                <!-- Institutions tab -->
                <div class="foundations-tab-content" id="tab-institutions" style="display: none;">
                    {% if tracked_institutions %}
                        {% for inst in tracked_institutions %}
                        <div class="tracked-entity-compact">
                            <a href="{{ url_for('foundations.institution_detail', institution_code=inst.code) }}" class="code-link">{{ inst.code }}</a>
                            <span class="entity-name-compact">{{ inst.display_name }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="dashboard-empty-state">No tracked institutions. <a href="{{ url_for('foundations.index', tab='institutions') }}">Browse institutions</a></p>
                    {% endif %}
                </div>

                <!-- Positions tab -->
                <div class="foundations-tab-content" id="tab-positions" style="display: none;">
                    {% if tracked_positions %}
                        {% for pos in tracked_positions %}
                        <div class="tracked-entity-compact">
                            <a href="{{ url_for('foundations.position_detail', position_code=pos.code) }}" class="code-link">{{ pos.code }}</a>
                            <span class="entity-name-compact">{{ pos.display_name }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="dashboard-empty-state">No tracked positions. <a href="{{ url_for('foundations.index', tab='positions') }}">Browse positions</a></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- CENTER COLUMN -->
    <div class="dashboard-center-column">

        <!-- Tracked Narratives Placeholder -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Tracked Narratives</h2>
            </div>
            <div class="card-body">
                <div class="dashboard-placeholder">
                    <p>No narratives tracked yet. Create your first narrative to begin tracking assessments.</p>
                </div>
            </div>
        </div>

        <!-- Tracked Scenarios -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Tracked Scenarios</h2>
                <a href="{{ url_for('scenarios.index') }}" class="btn btn-small btn-secondary">View All</a>
            </div>
            <div class="card-body">
                {% if my_marked_with_metrics %}
                <table class="marked-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>P<sub>i</sub></th>
                            <th>P<sub>c</sub></th>
                            <th>Vol</th>
                            <th>Vel</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in my_marked_with_metrics %}
                        <tr>
                            <td>
                                <a href="{{ url_for('scenarios.marked_detail', marked_id=item.marked.id) }}" class="code-link">
                                    {{ item.marked.scenario.scenario_code }}
                                </a>
                            </td>
                            <td class="metric-cell">{{ (item.pi * 100)|round(1) }}</td>
                            <td class="metric-cell metric-current">{{ (item.pc * 100)|round(1) }}</td>
                            <td class="metric-cell">{{ item.volatility|round(1) }}</td>
                            <td class="metric-cell">{{ item.velocity|round(1) }}</td>
                            <td class="metric-cell">{{ item.event_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="dashboard-empty-state">No marked scenarios yet. <a href="{{ url_for('scenarios.index') }}">Mark a scenario</a> to begin tracking.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="dashboard-right-column">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Events Feed</h2>
                <a href="{{ url_for('events.index') }}" class="btn btn-small btn-secondary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_events %}
                <div class="events-list-container">
                    {% for region, events in events_by_region.items()|sort %}
                    <div class="event-region-header">
                        {{ region|upper }}
                    </div>
                    {% for event in events %}
                        {{ event_card(event, selectable=false) }}
                    {% endfor %}
                    {% endfor %}
                </div>
                {% else %}
                <p class="dashboard-empty-state">No events yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Foundations category cycling
(function() {
    var tabs = ['actors', 'institutions', 'positions'];
    var labels = ['Actors', 'Institutions', 'Positions'];
    var currentIdx = 0;
    var labelEl = document.getElementById('foundations-cycle-label');
    var btn = document.getElementById('foundations-cycle-btn');

    function showTab(idx) {
        // Hide all
        document.querySelectorAll('.foundations-tab-content').forEach(function(c) {
            c.style.display = 'none';
        });
        // Show selected
        var target = document.getElementById('tab-' + tabs[idx]);
        if (target) target.style.display = 'block';
        labelEl.textContent = labels[idx];
    }

    btn.addEventListener('click', function() {
        currentIdx = (currentIdx + 1) % tabs.length;
        showTab(currentIdx);
    });
})();
</script>
{% endblock %}
