{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<div class="actor-detail-container">
    <!-- Left Sidebar: Named Actor Scenarios -->
    <div class="left-sidebar">
        <div class="card">
            <div class="card-header">
                <h2>Named Actor Scenarios</h2>
            </div>
            <div class="card-body">
                {% if named_scenarios %}
                    <div class="scenario-list">
                        {% for scenario in named_scenarios %}
                        <div class="scenario-item">
                            <a href="{{ url_for('scenarios.detail', scenario_id=scenario.id) }}">
                                {{ scenario.scenario_code }}
                            </a>
                            <div class="scenario-title">{{ scenario.title }}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No scenarios naming this actor</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Center Column: Main Actor Information -->
    <div class="center-column">
        <!-- Header Section -->
        <div class="card actor-header">
            <div class="card-body">
                <div class="actor-header-content">
                    <div class="actor-photo-placeholder">
                        {% set photo_path = 'images/actors/' ~ actor.actor_id|lower ~ '.jpg' %}
                        {% if photo_path %}
                            <img src="{{ url_for('static', filename=photo_path) }}" 
                                alt="{{ actor.get_display_name() }}" 
                                class="actor-photo"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="photo-circle" style="display:none;">
                                {{ actor.surname[0] }}{{ actor.given_name[0] }}
                            </div>
                        {% else %}
                            <div class="photo-circle">
                                {{ actor.surname[0] }}{{ actor.given_name[0] }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="actor-basic-info">
                        <h1 class="actor-name">{{ actor.surname }}, {{ actor.given_name }}</h1>
                        <div class="actor-meta">
                            <span class="actor-id">{{ actor.actor_id }}</span>
                            {% if actor.birth_year %}
                            <span class="actor-age">Born {{ actor.birth_year }} (Age: {{ 2026 - actor.birth_year }})</span>
                            {% endif %}
                        </div>
                        <div class="current-positions">
                            {% for tenure in actor.tenures if not tenure.tenure_end %}
                            <div class="current-position">
                                {{ tenure.position.position_title }}
                                <span class="position-institution">({{ tenure.position.institution.institution_name }})</span>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="relationships-link">
                            <a href="#family-associates">Family & Professional Associates →</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenure History Section -->
        <div class="card tenure-history">
            <div class="card-header">
                <h2>Tenure History</h2>
            </div>
            <div class="card-body">
                {% if actor.tenures %}
                <table class="tenure-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Related Events</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tenure in actor.tenures|sort(attribute='tenure_start', reverse=True) %}
                        <tr class="{% if not tenure.tenure_end %}current-tenure{% endif %}">
                            <td>
                                <div class="position-title">{{ tenure.position.position_title }}</div>
                                <div class="position-code">{{ tenure.position.position_code }}</div>
                            </td>
                            <td>{{ tenure.tenure_start.strftime('%Y-%m-%d') }}</td>
                            <td>{{ tenure.tenure_end.strftime('%Y-%m-%d') if tenure.tenure_end else 'Present' }}</td>
                            <td>
                                <!-- Placeholder for event count during this tenure -->
                                <span class="event-count-placeholder">—</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="empty-state">No tenure history recorded</p>
                {% endif %}
            </div>
        </div>

        <!-- Current Hierarchy Section -->
        <div class="card current-hierarchy" id="family-associates">
            <div class="card-header">
                <h2>Current Hierarchy</h2>
            </div>
            <div class="card-body">
                {% if hierarchy_json and hierarchy_json != 'null' %}
                <div class="orgchart-wrapper">
                    <div id="orgchart-container"></div>
                </div>
                {% else %}
                <div class="hierarchy-placeholder">
                    <p>No current position found for hierarchy display</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Family & Professional Associates Section -->
        <div class="card relationships-section">
            <div class="card-header">
                <h2>Family & Professional Associates</h2>
            </div>
            <div class="card-body">
                {% if family_relationships or professional_relationships %}
                    {% if family_relationships %}
                    <div class="relationship-category">
                        <h3>Family</h3>
                        <div class="relationship-list">
                            {% for rel in family_relationships %}
                            <div class="relationship-item">
                                <span class="relationship-label">{{ rel.label }}</span>
                                <a href="{{ url_for('foundations.actor_detail', actor_id=rel.actor_id) }}" class="relationship-actor">
                                    {{ rel.display_name }}
                                </a>
                                {% if rel.notes %}
                                <span class="relationship-notes">{{ rel.notes }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if professional_relationships %}
                    <div class="relationship-category">
                        <h3>Professional</h3>
                        <div class="relationship-list">
                            {% for rel in professional_relationships %}
                            <div class="relationship-item">
                                <span class="relationship-label">{{ rel.label }}</span>
                                <a href="{{ url_for('foundations.actor_detail', actor_id=rel.actor_id) }}" class="relationship-actor">
                                    {{ rel.display_name }}
                                </a>
                                {% if rel.notes %}
                                <span class="relationship-notes">{{ rel.notes }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="empty-state">No relationships recorded</p>
                {% endif %}
            </div>
        </div>

        <!-- Event Metrics Section (Placeholder) -->
        <div class="card event-metrics">
            <div class="card-header">
                <h2>Event Metrics</h2>
            </div>
            <div class="card-body">
                <div class="metrics-placeholder">
                    <p>Event frequency and action type distribution table will be rendered here</p>
                    <p class="placeholder-note">(Rows: as subj / as obj / as actor × Columns: medium/short timeframes)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar: Recent Events -->
    <div class="right-sidebar">
        <div class="card">
            <div class="card-header">
                <h2>Recent Events</h2>
            </div>
            <div class="card-body">
                <!-- As Actor -->
                {% if events_as_actor %}
                <div class="event-category">
                    <h3>As Actor</h3>
                    <div class="event-list">
                        {% for event in events_as_actor[:5] %}
                        <div class="event-item">
                            <a href="{{ url_for('events.detail', event_code=event.event_code) }}">
                                {{ event.event_code }}
                            </a>
                            <div class="event-meta">
                                <span class="action-code">{{ event.action_code }}</span>
                                <span class="event-date">{{ event.rec_timestamp.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- As Subject -->
                {% if events_as_subject %}
                <div class="event-category">
                    <h3>As Subj</h3>
                    <div class="event-list">
                        {% for event in events_as_subject[:5] %}
                        <div class="event-item">
                            <a href="{{ url_for('events.detail', event_code=event.event_code) }}">
                                {{ event.event_code }}
                            </a>
                            <div class="event-meta">
                                <span class="action-code">{{ event.action_code }}</span>
                                <span class="event-date">{{ event.rec_timestamp.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- As Object -->
                {% if events_as_object %}
                <div class="event-category">
                    <h3>As Obj</h3>
                    <div class="event-list">
                        {% for event in events_as_object[:5] %}
                        <div class="event-item">
                            <a href="{{ url_for('events.detail', event_code=event.event_code) }}">
                                {{ event.event_code }}
                            </a>
                            <div class="event-meta">
                                <span class="action-code">{{ event.action_code }}</span>
                                <span class="event-date">{{ event.rec_timestamp.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if not events_as_actor and not events_as_subject and not events_as_object %}
                <p class="empty-state">No recent events (last 30 days)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if hierarchy_json and hierarchy_json != 'null' %}
<script>
(function() {
    var data = {{ hierarchy_json|safe }};
    if (!data) return;

    var container = document.getElementById('orgchart-container');
    if (!container) return;

    function buildNode(node) {
        var li = document.createElement('li');

        var nodeDiv = document.createElement('div');
        nodeDiv.className = 'orgchart-node' + (node.is_current ? ' orgchart-node--current' : '');

        var link = document.createElement('a');
        link.href = '/positions/' + encodeURIComponent(node.position_code);
        link.className = 'orgchart-node-link';

        var titleEl = document.createElement('div');
        titleEl.className = 'orgchart-node-title';
        titleEl.textContent = node.title;

        var holderEl = document.createElement('div');
        holderEl.className = 'orgchart-node-holder';
        holderEl.textContent = node.holder;

        link.appendChild(titleEl);
        link.appendChild(holderEl);
        nodeDiv.appendChild(link);
        li.appendChild(nodeDiv);

        if (node.children && node.children.length > 0) {
            var childUl = document.createElement('ul');
            for (var i = 0; i < node.children.length; i++) {
                childUl.appendChild(buildNode(node.children[i]));
            }
            li.appendChild(childUl);
        }

        return li;
    }

    var tree = document.createElement('div');
    tree.className = 'orgchart-tree';

    var rootUl = document.createElement('ul');
    rootUl.appendChild(buildNode(data));
    tree.appendChild(rootUl);
    container.appendChild(tree);
})();
</script>
{% endif %}
{% endblock %}