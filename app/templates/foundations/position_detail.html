{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<div class="actor-detail-container">
    <!-- Left Sidebar: Named Scenarios -->
    <div class="left-sidebar">
        <div class="card">
            <div class="card-header">
                <h2>Named Scenarios</h2>
            </div>
            <div class="card-body">
                {% if named_scenarios %}
                    <div class="scenario-list">
                        {% for scenario in named_scenarios %}
                        <div class="scenario-item">
                            <a href="{{ url_for('scenarios.detail', scenario_id=scenario.id) }}">
                                {{ scenario.scenario_code }}
                            </a>
                            <div class="scenario-title">{{ scenario.title }}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-state">No scenarios naming this position</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Center Column: Main Position Information -->
    <div class="center-column">
        <!-- Header Section -->
        <div class="card actor-header">
            <div class="card-body">
                <div class="actor-header-content">
                    <div class="actor-photo-placeholder">
                        <div class="photo-circle">
                            {{ position.position_title[:2]|upper }}
                        </div>
                    </div>
                    <div class="actor-basic-info">
                        <h1 class="actor-name">{{ position.position_title }}</h1>
                        <div class="actor-meta">
                            <span class="actor-id">{{ position.position_code }}</span>
                            {% if position.hierarchy_level %}
                            <span class="actor-age">Level: {{ position.hierarchy_level }}</span>
                            {% endif %}
                        </div>
                        <div class="current-positions">
                            <div class="current-position">
                                <a href="{{ url_for('foundations.institution_detail', institution_code=position.institution_code) }}" style="color: var(--primary); text-decoration: none;">
                                    {{ position.institution.institution_name }}
                                </a>
                            </div>
                            <div class="current-position">
                                {% if current_holder %}
                                    <span class="status-badge" style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Occupied</span>
                                {% else %}
                                    <span class="status-badge" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">Vacant</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Holder Card -->
        <div class="card tenure-history">
            <div class="card-header">
                <h2>Current Holder</h2>
            </div>
            <div class="card-body">
                {% if current_holder %}
                <div style="display: flex; align-items: center; gap: var(--space-md);">
                    <div class="actor-photo-placeholder">
                        {% set photo_path = 'images/actors/' ~ current_holder.actor_id|lower ~ '.jpg' %}
                        <img src="{{ url_for('static', filename=photo_path) }}"
                            alt="{{ current_holder.get_display_name() }}"
                            class="actor-photo"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="photo-circle" style="display:none;">
                            {{ current_holder.surname[0] }}{{ current_holder.given_name[0] }}
                        </div>
                    </div>
                    <div>
                        <div style="font-weight: 500;">
                            <a href="{{ url_for('foundations.actor_detail', actor_id=current_holder.actor_id) }}" style="color: var(--primary); text-decoration: none;">
                                {{ current_holder.get_display_name() }}
                            </a>
                        </div>
                        {% if current_tenure %}
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">
                            Since {{ current_tenure.tenure_start.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p class="empty-state">Position currently vacant</p>
                {% endif %}
            </div>
        </div>

        <!-- Tenure History Table -->
        <div class="card tenure-history">
            <div class="card-header">
                <h2>Tenure History</h2>
            </div>
            <div class="card-body">
                {% if tenures_data %}
                <table class="tenure-table">
                    <thead>
                        <tr>
                            <th>Actor</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for td in tenures_data %}
                        <tr class="{% if td.is_current %}current-tenure{% endif %}">
                            <td>
                                <a href="{{ url_for('foundations.actor_detail', actor_id=td.tenure.actor.actor_id) }}" style="color: var(--primary); text-decoration: none;">
                                    {{ td.tenure.actor.get_display_name() }}
                                </a>
                            </td>
                            <td>{{ td.tenure.tenure_start.strftime('%Y-%m-%d') }}</td>
                            <td>{{ td.tenure.tenure_end.strftime('%Y-%m-%d') if td.tenure.tenure_end else 'Present' }}</td>
                            <td>{{ td.duration }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="empty-state">No tenure history recorded</p>
                {% endif %}
            </div>
        </div>

        <!-- Organizational Context Card -->
        <div class="card tenure-history">
            <div class="card-header">
                <h2>Organizational Context</h2>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                    <!-- Reports To -->
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">Reports To</div>
                        {% if reports_to_position %}
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <a href="{{ url_for('foundations.position_detail', position_code=reports_to_position.position_code) }}" style="color: var(--primary); text-decoration: none;">
                                {{ reports_to_position.position_title }}
                            </a>
                            <span style="color: var(--text-tertiary); font-size: 0.8rem;">({{ reports_to_position.position_code }})</span>
                            {% if reports_to_holder %}
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">- {{ reports_to_holder.get_display_name() }}</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <div style="color: var(--text-tertiary); font-style: italic;">Top-level position (no superior)</div>
                        {% endif %}
                    </div>

                    <!-- Direct Reports -->
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">Direct Reports</div>
                        {% if direct_reports_count > 0 %}
                        <div>
                            <a href="#hierarchy-section" style="color: var(--primary); text-decoration: none;">
                                {{ direct_reports_count }} position{{ 's' if direct_reports_count != 1 else '' }}
                            </a>
                        </div>
                        {% else %}
                        <div style="color: var(--text-tertiary); font-style: italic;">No direct reports</div>
                        {% endif %}
                    </div>

                    <!-- Peer Positions -->
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">Peer Positions</div>
                        {% if peers %}
                        <div>
                            <a href="#hierarchy-section" style="color: var(--primary); text-decoration: none;">
                                {{ peers|length }} peer{{ 's' if peers|length != 1 else '' }}
                            </a>
                        </div>
                        {% else %}
                        <div style="color: var(--text-tertiary); font-style: italic;">No peer positions</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar: Recent Events -->
    <div class="right-sidebar">
        <div class="card">
            <div class="card-header">
                <h2>Recent Events</h2>
            </div>
            <div class="card-body">
                <!-- As Subject -->
                {% if events_as_subject %}
                <div class="event-category">
                    <h3>As Subj</h3>
                    <div class="event-list">
                        {% for event in events_as_subject[:5] %}
                        <div class="event-item">
                            <a href="{{ url_for('events.detail_cf_route', event_code=event.event_code) }}">
                                {{ event.event_code }}
                            </a>
                            <div class="event-meta">
                                <span class="action-code">{{ event.action_code }}</span>
                                <span class="event-date">{{ event.rec_timestamp.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- As Object -->
                {% if events_as_object %}
                <div class="event-category">
                    <h3>As Obj</h3>
                    <div class="event-list">
                        {% for event in events_as_object[:5] %}
                        <div class="event-item">
                            <a href="{{ url_for('events.detail_cf_route', event_code=event.event_code) }}">
                                {{ event.event_code }}
                            </a>
                            <div class="event-meta">
                                <span class="action-code">{{ event.action_code }}</span>
                                <span class="event-date">{{ event.rec_timestamp.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if not events_as_subject and not events_as_object %}
                <p class="empty-state">No recent events (last 30 days)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Full-Width Position Hierarchy (below 3-column layout) -->
<div style="max-width: 1600px; margin: var(--space-lg) auto 0;" id="hierarchy-section">
    <div class="card">
        <div class="card-header">
            <h2>Position Hierarchy</h2>
        </div>
        <div class="card-body">
            {% if hierarchy_json and hierarchy_json != 'null' %}
            <div class="orgchart-wrapper">
                <div id="orgchart-container"></div>
            </div>
            {% else %}
            <div class="hierarchy-placeholder">
                <p>No hierarchy data available for this position</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if hierarchy_json and hierarchy_json != 'null' %}
<script>
(function() {
    var data = {{ hierarchy_json|safe }};
    if (!data) return;

    var container = document.getElementById('orgchart-container');
    if (!container) return;

    // --- Modal infrastructure ---
    var modal = document.createElement('div');
    modal.className = 'hierarchy-modal-overlay';
    modal.style.display = 'none';
    modal.innerHTML =
        '<div class="hierarchy-modal">' +
            '<div class="hierarchy-modal-header">' +
                '<h3 class="hierarchy-modal-title"></h3>' +
                '<button class="hierarchy-modal-close">&times;</button>' +
            '</div>' +
            '<div class="hierarchy-modal-body"></div>' +
        '</div>';
    document.body.appendChild(modal);

    var modalTitle = modal.querySelector('.hierarchy-modal-title');
    var modalBody = modal.querySelector('.hierarchy-modal-body');
    var modalClose = modal.querySelector('.hierarchy-modal-close');

    function closeModal() { modal.style.display = 'none'; }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });

    function openReportsModal(title, reports) {
        modalTitle.textContent = title;
        modalBody.innerHTML = '';
        var table = document.createElement('table');
        table.className = 'hierarchy-modal-table';
        var thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Position Code</th><th>Title</th><th>Holder</th></tr>';
        table.appendChild(thead);
        var tbody = document.createElement('tbody');
        for (var i = 0; i < reports.length; i++) {
            var r = reports[i];
            var tr = document.createElement('tr');
            var tdCode = document.createElement('td');
            var codeLink = document.createElement('a');
            codeLink.href = '/foundations/position/' + encodeURIComponent(r.position_code);
            codeLink.textContent = r.position_code;
            codeLink.className = 'hierarchy-modal-link';
            tdCode.appendChild(codeLink);
            var tdTitle = document.createElement('td');
            tdTitle.textContent = r.title;
            var tdHolder = document.createElement('td');
            tdHolder.textContent = r.holder;
            tr.appendChild(tdCode);
            tr.appendChild(tdTitle);
            tr.appendChild(tdHolder);
            tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        modalBody.appendChild(table);
        modal.style.display = 'flex';
    }

    // --- Tree builder ---
    function buildNode(node) {
        var li = document.createElement('li');
        var nodeDiv = document.createElement('div');

        if (node.is_placeholder) {
            nodeDiv.className = 'orgchart-node orgchart-node--placeholder';
            var btn = document.createElement('button');
            btn.className = 'orgchart-node-link orgchart-placeholder-btn';
            btn.type = 'button';

            var titleEl = document.createElement('div');
            titleEl.className = 'orgchart-node-title';
            titleEl.textContent = node.title;

            var holderEl = document.createElement('div');
            holderEl.className = 'orgchart-node-holder';
            holderEl.textContent = node.holder;

            btn.appendChild(titleEl);
            btn.appendChild(holderEl);
            btn.addEventListener('click', (function(n) {
                return function() { openReportsModal(n.title, n.all_reports); };
            })(node));
            nodeDiv.appendChild(btn);
        } else {
            nodeDiv.className = 'orgchart-node' + (node.is_current ? ' orgchart-node--current' : '');
            var link = document.createElement('a');
            link.href = '/foundations/position/' + encodeURIComponent(node.position_code);
            link.className = 'orgchart-node-link';

            var titleEl = document.createElement('div');
            titleEl.className = 'orgchart-node-title';
            titleEl.textContent = node.title;

            var holderEl = document.createElement('div');
            holderEl.className = 'orgchart-node-holder';
            holderEl.textContent = node.holder;

            link.appendChild(titleEl);
            link.appendChild(holderEl);
            nodeDiv.appendChild(link);
        }

        li.appendChild(nodeDiv);

        if (node.children && node.children.length > 0) {
            var childUl = document.createElement('ul');
            for (var i = 0; i < node.children.length; i++) {
                childUl.appendChild(buildNode(node.children[i]));
            }
            li.appendChild(childUl);
        }

        return li;
    }

    var tree = document.createElement('div');
    tree.className = 'orgchart-tree';

    var rootUl = document.createElement('ul');
    rootUl.appendChild(buildNode(data));
    tree.appendChild(rootUl);
    container.appendChild(tree);
})();
</script>
{% endif %}
{% endblock %}
