{% extends "base.html" %}

{% block title %}Create Narrative{% endblock %}

{% block extra_css %}
<style>
    .dynamic-row {
        display: grid;
        gap: var(--space-sm);
        align-items: end;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--color-border);
    }
    .dynamic-row:last-child {
        border-bottom: none;
    }
    .resolution-row {
        grid-template-columns: 1fr 130px 80px 120px 90px 36px;
    }
    .linkage-row {
        grid-template-columns: 1fr 110px 90px 36px;
    }
    .dynamic-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
    }
    .dynamic-section-label {
        font-family: var(--font-body);
        font-size: 0.8rem;
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .col-label {
        font-size: 0.7rem;
        color: var(--color-text-dim);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.2rem;
    }
    .btn-remove {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-accent-warning);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        padding: 0.3rem 0.5rem;
        height: 100%;
        align-self: end;
    }
    .btn-remove:hover {
        background: rgba(235, 100, 51, 0.1);
        border-color: var(--color-accent-warning);
    }
    .subsection-card {
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-top: var(--space-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 960px;">
    <h1>Create New Narrative</h1>

    <div class="card">
        <div class="card-body">
            <form method="POST">

                <!-- Core Fields -->
                <div class="form-group">
                    <label class="form-label" for="narrative_code">Narrative Code</label>
                    <input type="text" id="narrative_code" name="narrative_code" class="form-input"
                           placeholder="n.20240601.weu.001" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="title">Title</label>
                    <input type="text" id="title" name="title" class="form-input"
                           placeholder="European Strategic Realignment" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">Description</label>
                    <textarea id="description" name="description" class="form-textarea" rows="4"
                              placeholder="Describe the narrative thesis and its geopolitical context..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="initial_trend">Initial Trend</label>
                    <select id="initial_trend" name="initial_trend" class="form-select" required>
                        <option value="2">Strongly Positive</option>
                        <option value="1">Positive</option>
                        <option value="0" selected>Stable</option>
                        <option value="-1">Negative</option>
                        <option value="-2">Strongly Negative</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="res_horizon">Resolution Horizon</label>
                    <input type="date" id="res_horizon" name="res_horizon" class="form-input" required>
                </div>

                <!-- Resolution Conditions -->
                <div class="subsection-card">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-label">Resolution Conditions</span>
                        <button type="button" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;"
                                onclick="addResolutionRow()">+ Add Row</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 130px 80px 120px 90px 36px; gap: var(--space-sm); margin-bottom: 0.25rem;">
                        <div class="col-label">Entity Code</div>
                        <div class="col-label">Entity Type</div>
                        <div class="col-label">Action Code</div>
                        <div class="col-label">Polarity</div>
                        <div class="col-label">Weight</div>
                        <div></div>
                    </div>

                    <div id="resolution-rows">
                        <div class="dynamic-row resolution-row">
                            <input type="text" name="entity_code[]" class="form-input" placeholder="e.g. MAC.FRA">
                            <select name="entity_type[]" class="form-select">
                                <option value="actor">Actor</option>
                                <option value="position">Position</option>
                                <option value="institution">Institution</option>
                            </select>
                            <input type="text" name="action_code[]" class="form-input" placeholder="ACT01">
                            <select name="polarity[]" class="form-select">
                                <option value="true">Positive</option>
                                <option value="false">Negative</option>
                            </select>
                            <select name="weight[]" class="form-select">
                                <option value="1.5">High</option>
                                <option value="1.0" selected>Med</option>
                                <option value="0.5">Low</option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeRow(this)" title="Remove row">×</button>
                        </div>
                    </div>
                </div>

                <!-- Scenario Linkages -->
                <div class="subsection-card">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-label">Scenario Linkages</span>
                        <button type="button" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;"
                                onclick="addLinkageRow()">+ Add Row</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 110px 90px 36px; gap: var(--space-sm); margin-bottom: 0.25rem;">
                        <div class="col-label">Marked Scenario</div>
                        <div class="col-label">Relationship</div>
                        <div class="col-label">Potency</div>
                        <div></div>
                    </div>

                    <div id="linkage-rows">
                        <div class="dynamic-row linkage-row">
                            <select name="marked_scenario_id[]" class="form-select">
                                <option value="">— Select scenario —</option>
                                {% for ms in marked_scenarios %}
                                <option value="{{ ms.id }}">{{ ms.display_name }}</option>
                                {% endfor %}
                            </select>
                            <select name="relationship[]" class="form-select">
                                <option value="true">Direct</option>
                                <option value="false">Inverse</option>
                            </select>
                            <select name="potency[]" class="form-select">
                                <option value="1.5">High</option>
                                <option value="1.0" selected>Med</option>
                                <option value="0.5">Low</option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeRow(this)" title="Remove row">×</button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-md mt-lg">
                    <button type="submit" class="btn btn-primary">Create Narrative</button>
                    <a href="{{ url_for('narratives.index') }}" class="btn btn-secondary">Cancel</a>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Snapshot of marked_scenarios for cloning linkage rows
const markedScenariosOptions = `{% for ms in marked_scenarios %}<option value="{{ ms.id }}">{{ ms.display_name }}</option>{% endfor %}`;

function addResolutionRow() {
    const container = document.getElementById('resolution-rows');
    const row = document.createElement('div');
    row.className = 'dynamic-row resolution-row';
    row.innerHTML = `
        <input type="text" name="entity_code[]" class="form-input" placeholder="e.g. MAC.FRA">
        <select name="entity_type[]" class="form-select">
            <option value="actor">Actor</option>
            <option value="position">Position</option>
            <option value="institution">Institution</option>
        </select>
        <input type="text" name="action_code[]" class="form-input" placeholder="ACT01">
        <select name="polarity[]" class="form-select">
            <option value="true">Positive</option>
            <option value="false">Negative</option>
        </select>
        <select name="weight[]" class="form-select">
            <option value="1.5">High</option>
            <option value="1.0" selected>Med</option>
            <option value="0.5">Low</option>
        </select>
        <button type="button" class="btn-remove" onclick="removeRow(this)" title="Remove row">×</button>
    `;
    container.appendChild(row);
}

function addLinkageRow() {
    const container = document.getElementById('linkage-rows');
    const row = document.createElement('div');
    row.className = 'dynamic-row linkage-row';
    row.innerHTML = `
        <select name="marked_scenario_id[]" class="form-select">
            <option value="">— Select scenario —</option>
            ${markedScenariosOptions}
        </select>
        <select name="relationship[]" class="form-select">
            <option value="true">Direct</option>
            <option value="false">Inverse</option>
        </select>
        <select name="potency[]" class="form-select">
            <option value="1.5">High</option>
            <option value="1.0" selected>Med</option>
            <option value="0.5">Low</option>
        </select>
        <button type="button" class="btn-remove" onclick="removeRow(this)" title="Remove row">×</button>
    `;
    container.appendChild(row);
}

function removeRow(btn) {
    btn.closest('.dynamic-row').remove();
}
</script>
{% endblock %}
